<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clock</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --clock: #e0e0e0;
      --countdown: #66ddaa;
      --quote: #8888aa;
      --btn-bg: rgba(255,255,255,0.08);
      --btn-border: rgba(255,255,255,0.15);
      --btn-text: #c0c0d0;
      --btn-bg-hover: rgba(255,255,255,0.15);
      --btn-border-hover: rgba(255,255,255,0.3);
      --input-bg: rgba(255,255,255,0.06);
      --input-border: rgba(255,255,255,0.15);
      --input-text: #c0c0d0;
      --input-placeholder: #555566;
      --input-border-focus: rgba(255,255,255,0.35);
      --cancel: #665566;
      --cancel-hover: #aa6666;
      --panel-bg: rgba(255,255,255,0.05);
      --panel-border: rgba(255,255,255,0.14);
      --panel-title: #aab4cf;
      --panel-track: #dbe3ff;
      --panel-btn-bg: rgba(255,255,255,0.1);
      --panel-btn-border: rgba(255,255,255,0.2);
      --panel-btn-text: #d2d8ea;
      --panel-progress-bg: rgba(255,255,255,0.12);
      --panel-time: #9aa6c7;
      --accent: #66ddaa;
    }
    body.light {
      --bg: #c8fff1;
      --clock: #06443e;
      --countdown: #00d7ac;
      --quote: #0f6f65;
      --btn-bg: rgba(0,128,112,0.10);
      --btn-border: rgba(0,102,90,0.42);
      --btn-text: #075750;
      --btn-bg-hover: rgba(0,128,112,0.18);
      --btn-border-hover: rgba(0,102,90,0.56);
      --input-bg: rgba(0,128,112,0.08);
      --input-border: rgba(0,102,90,0.46);
      --input-text: #075750;
      --input-placeholder: #2f8f83;
      --input-border-focus: rgba(0,102,90,0.62);
      --cancel: #1d8e81;
      --cancel-hover: #b45757;
      --panel-bg: rgba(0,128,112,0.10);
      --panel-border: rgba(0,128,112,0.22);
      --panel-title: #0b766c;
      --panel-track: #06443e;
      --panel-btn-bg: rgba(0,128,112,0.12);
      --panel-btn-border: rgba(0,128,112,0.26);
      --panel-btn-text: #06443e;
      --panel-progress-bg: rgba(0,128,112,0.18);
      --panel-time: #0f7b70;
      --accent: #00e8b8;
    }
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Courier New', monospace;
      transition: background 0.25s ease, color 0.25s ease;
    }
    .clock {
      color: var(--clock);
      font-size: 6rem;
      letter-spacing: 0.05em;
      transition: color 0.4s;
    }
    .clock.countdown { color: var(--countdown); }
    .quote {
      color: var(--quote);
      font-size: 1.2rem;
      max-width: 600px;
      text-align: center;
      margin-top: 2rem;
      padding: 0.9rem 1.1rem;
      border-radius: 12px;
      border: 1px solid color-mix(in srgb, var(--accent) 32%, transparent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      box-shadow:
        inset 0 0 0.6rem color-mix(in srgb, var(--accent) 10%, transparent),
        0 0 1.1rem color-mix(in srgb, var(--accent) 22%, transparent);
      line-height: 1.6;
      transition: opacity 0.5s, border-color 0.25s, box-shadow 0.25s;
    }
    body.light .quote {
      border-color: rgba(0,82,72,0.5);
      box-shadow:
        inset 0 0 0 1px rgba(0,82,72,0.28),
        inset 0 0 0.6rem color-mix(in srgb, var(--accent) 10%, transparent),
        0 0 1.1rem color-mix(in srgb, var(--accent) 22%, transparent);
    }
    .timer-controls {
      margin-top: 2rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }
    .timer-controls.hidden { display: none; }
    .timer-btn {
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      color: var(--btn-text);
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 0.35rem color-mix(in srgb, var(--accent) 35%, transparent);
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    body.light .timer-btn {
      box-shadow:
        inset 0 0 0 1px rgba(0,82,72,0.28),
        0 0 0.35rem color-mix(in srgb, var(--accent) 35%, transparent);
    }
    .timer-btn:hover {
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
      box-shadow:
        0 0 0.45rem color-mix(in srgb, var(--accent) 55%, transparent),
        0 0 0.95rem color-mix(in srgb, var(--accent) 35%, transparent);
    }
    .icon-btn {
      width: 38px;
      height: 38px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05rem;
      line-height: 1;
    }
    #muteBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 20;
    }
    #updateBtn {
      position: fixed;
      bottom: 14px;
      left: 14px;
      z-index: 20;
    }
    #themeBtn {
      position: fixed;
      bottom: 58px;
      left: 14px;
      z-index: 20;
    }
    #soundModeBtn {
      margin-top: 0.75rem;
    }
    .timer-input {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--input-text);
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      padding: 0.5rem 0.6rem;
      border-radius: 6px;
      width: 60px;
      text-align: center;
      outline: none;
    }
    body.light .timer-input {
      box-shadow: inset 0 0 0 1px rgba(0,82,72,0.26);
    }
    .timer-input::placeholder { color: var(--input-placeholder); }
    .timer-input:focus { border-color: var(--input-border-focus); }
    .cancel-btn {
      background: none;
      border: none;
      color: var(--cancel);
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 1.5rem;
      padding: 0.3rem 0.8rem;
      transition: color 0.2s;
    }
    .cancel-btn:hover { color: var(--cancel-hover); }
    .cancel-btn.hidden { display: none; }
    .hidden { display: none !important; }
    .playlist {
      margin-top: 1rem;
      width: min(620px, 92vw);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      padding: 0.8rem 0.9rem;
      box-sizing: border-box;
    }
    .playlist-title {
      color: var(--panel-title);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      letter-spacing: 0.04em;
    }
    .playlist-track {
      color: var(--panel-track);
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.55rem;
    }
    .playlist-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.55rem;
    }
    .playlist-btn {
      background: var(--panel-btn-bg);
      border: 1px solid var(--panel-btn-border);
      color: var(--panel-btn-text);
      font-family: 'Courier New', monospace;
      font-size: 0.82rem;
      padding: 0.3rem 0.65rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 0.3rem color-mix(in srgb, var(--accent) 30%, transparent);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .playlist-btn:hover {
      box-shadow:
        0 0 0.4rem color-mix(in srgb, var(--accent) 50%, transparent),
        0 0 0.8rem color-mix(in srgb, var(--accent) 28%, transparent);
    }
    .playlist-progress {
      height: 6px;
      background: var(--panel-progress-bg);
      border-radius: 999px;
      cursor: pointer;
      overflow: hidden;
    }
    .playlist-progress-fill {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width 0.1s linear;
    }
    .playlist-time {
      margin-top: 0.35rem;
      color: var(--panel-time);
      font-size: 0.75rem;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="clock" id="clock"></div>
  <div class="quote" id="quote"></div>
  <div class="timer-controls" id="timerControls">
    <button class="timer-btn" onclick="startTimer(15)">15m</button>
    <button class="timer-btn" onclick="startTimer(30)">30m</button>
    <button class="timer-btn" onclick="startTimer(45)">45m</button>
    <button class="timer-btn" onclick="startTimer(60)">60m</button>
    <input class="timer-input" id="customMin" type="number" min="1" max="240" placeholder="min"
           onkeydown="if(event.key==='Enter'){startTimer(parseInt(this.value))}">
  </div>
  <button class="timer-btn hidden" id="soundModeBtn" onclick="toggleSoundMode()">Sound: Rain</button>
  <button class="timer-btn icon-btn hidden" id="muteBtn" onclick="toggleMute()" title="Toggle mute" aria-label="Toggle mute">üîä</button>
  <button class="timer-btn icon-btn" id="updateBtn" onclick="triggerUpdate()" title="Check for updates" aria-label="Check for updates">‚Üª</button>
  <button class="timer-btn icon-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">‚óê</button>
  <button class="cancel-btn hidden" id="cancelBtn" onclick="cancelTimer()">[ abbrechen ]</button>
  <div class="playlist hidden" id="playlistPanel">
    <div class="playlist-title">LoFi Playlist (10 Tracks)</div>
    <div class="playlist-track" id="playlistTrackName">-</div>
    <div class="playlist-controls">
      <button class="playlist-btn" onclick="prevLofiTrack()">Prev</button>
      <button class="playlist-btn" id="lofiPlayPauseBtn" onclick="toggleLofiPlayPause()">Play</button>
      <button class="playlist-btn" onclick="nextLofiTrack()">Next</button>
    </div>
    <div class="playlist-progress" id="playlistProgress" onclick="seekLofi(event)">
      <div class="playlist-progress-fill" id="playlistProgressFill"></div>
    </div>
    <div class="playlist-time" id="playlistTime">0:00 / 0:00</div>
  </div>
  <audio id="lofiAudio" preload="metadata"></audio>
  <script>
    const quotes = [
      "The only way to do great work is to love what you do. ‚Äî Steve Jobs",
      "It does not matter how slowly you go as long as you do not stop. ‚Äî Confucius",
      "Believe you can and you're halfway there. ‚Äî Theodore Roosevelt",
      "Act as if what you do makes a difference. It does. ‚Äî William James",
      "What you get by achieving your goals is not as important as what you become by achieving your goals. ‚Äî Zig Ziglar",
      "Start where you are. Use what you have. Do what you can. ‚Äî Arthur Ashe",
      "Everything you've ever wanted is on the other side of fear. ‚Äî George Addair",
      "The future belongs to those who believe in the beauty of their dreams. ‚Äî Eleanor Roosevelt",
      "Hard times don't create heroes. It is during the hard times when the hero within us is revealed. ‚Äî Bob Riley",
      "Don't watch the clock; do what it does. Keep going. ‚Äî Sam Levenson",
      "You are never too old to set another goal or to dream a new dream. ‚Äî C.S. Lewis",
      "Success is not final, failure is not fatal: it is the courage to continue that counts. ‚Äî Winston Churchill",
      "In the middle of every difficulty lies opportunity. ‚Äî Albert Einstein",
      "The best time to plant a tree was 20 years ago. The second best time is now. ‚Äî Chinese Proverb",
      "Your limitation ‚Äî it's only your imagination.",
      "Push yourself, because no one else is going to do it for you.",
      "Great things never come from comfort zones.",
      "Dream it. Wish it. Do it.",
      "The harder you work for something, the greater you'll feel when you achieve it.",
      "Do something today that your future self will thank you for."
    ];

    let lastIndex = -1;
    let timerInterval = null;
    let timerEndTime = null;
    let rainCtx = null;
    let rainNodes = [];
    let soundMode = 'rain';
    let isMuted = false;
    let theme = 'dark';
    const lofiAudio = document.getElementById('lofiAudio');
    const lofiTracks = [
      { name: 'Magenta Metropolis', src: 'audio/lofi/track01.mp3' },
      { name: 'Lucid Dreaming', src: 'audio/lofi/track02.mp3' },
      { name: 'Downtown Walk', src: 'audio/lofi/track03.mp3' },
      { name: 'Hot Pepper', src: 'audio/lofi/track04.mp3' },
      { name: 'Rain Book And Cup Of Tea', src: 'audio/lofi/track05.mp3' },
      { name: 'Rooftop', src: 'audio/lofi/track06.mp3' },
      { name: 'Morning Espresso', src: 'audio/lofi/track07.mp3' },
      { name: 'Rain Book And Cup Of Tea Loop', src: 'audio/lofi/track08.mp3' },
      { name: 'Dusk Horizon', src: 'audio/lofi/track09.mp3' },
      { name: 'Hometown Rain', src: 'audio/lofi/track10.mp3' }
    ];
    let currentLofiTrack = 0;
    let shuffledOrder = [];
    let shufflePos = 0;
    let updatePending = false;

    function showQuote() {
      let index;
      do {
        index = Math.floor(Math.random() * quotes.length);
      } while (index === lastIndex);
      lastIndex = index;
      const el = document.getElementById('quote');
      el.style.opacity = 0;
      setTimeout(() => {
        el.textContent = quotes[index];
        el.style.opacity = 1;
      }, 500);
    }

    function updateSoundButton() {
      const btn = document.getElementById('soundModeBtn');
      btn.textContent = soundMode === 'rain' ? 'Sound: Rain' : 'Sound: LoFi';
    }

    function applyTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      try { localStorage.setItem('clock_theme', theme); } catch (_) {}
      updateThemeButton();
    }

    function updateThemeButton() {
      const btn = document.getElementById('themeBtn');
      btn.textContent = theme === 'dark' ? '‚óê' : '‚óë';
      btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
      btn.setAttribute('aria-label', btn.title);
    }

    function toggleTheme() {
      applyTheme(theme === 'dark' ? 'light' : 'dark');
    }

    function toggleSoundMode() {
      soundMode = soundMode === 'rain' ? 'lofi' : 'rain';
      updateSoundButton();
      updatePlaylistVisibility();
      if (timerInterval) {
        stopAmbience();
        startAmbience();
      }
    }

    function updateMuteButton() {
      const btn = document.getElementById('muteBtn');
      btn.textContent = isMuted ? 'üîá' : 'üîä';
      btn.title = isMuted ? 'Unmute' : 'Mute';
      btn.setAttribute('aria-label', isMuted ? 'Unmute' : 'Mute');
    }

    function applyRainMuteState() {
      if (!rainCtx || rainNodes.length < 9) return;
      const gain = rainNodes[3];
      const patterGain = rainNodes[8];
      const now = rainCtx.currentTime;
      gain.gain.cancelScheduledValues(now);
      patterGain.gain.cancelScheduledValues(now);
      gain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.15, now + 0.1);
      patterGain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.04, now + 0.1);
    }

    function toggleMute() {
      isMuted = !isMuted;
      lofiAudio.muted = isMuted;
      applyRainMuteState();
      updateMuteButton();
    }

    function triggerUpdate() {
      if (updatePending) return;
      updatePending = true;
      setUpdateButtonBusy(true);
      const sent = sendToSwift('update');
      if (!sent) {
        updatePending = false;
        setUpdateButtonBusy(false);
        alert('Update konnte nicht gestartet werden (Native Bridge nicht verf√ºgbar).');
      }
    }

    function handleNativeUpdateState(payload) {
      if (!payload || typeof payload !== 'object') return;
      const state = payload.state || '';
      const message = payload.message || '';

      if (state === 'started' || state === 'progress' || state === 'installing' || state === 'already_running') {
        updatePending = true;
        setUpdateButtonBusy(true, message || 'Checking for updates...');
        return;
      }

      if (state === 'error') {
        updatePending = false;
        setUpdateButtonBusy(false);
        if (message) alert(message);
        return;
      }

      if (state === 'finished') {
        updatePending = false;
        setUpdateButtonBusy(false);
        return;
      }
    }

    function setUpdateButtonBusy(busy, statusText = '') {
      const btn = document.getElementById('updateBtn');
      if (busy) {
        btn.textContent = '‚Ä¶';
        const label = statusText || 'Checking for updates...';
        btn.title = label;
        btn.setAttribute('aria-label', label);
        btn.disabled = true;
      } else {
        btn.textContent = '‚Üª';
        btn.title = 'Check for updates';
        btn.setAttribute('aria-label', 'Check for updates');
        btn.disabled = false;
      }
    }

    function updatePlaylistVisibility() {
      const panel = document.getElementById('playlistPanel');
      panel.classList.toggle('hidden', !timerInterval || soundMode !== 'lofi');
    }

    function updateTrackDisplay() {
      document.getElementById('playlistTrackName').textContent = lofiTracks[currentLofiTrack].name;
    }

    function updateLofiPlayButton() {
      document.getElementById('lofiPlayPauseBtn').textContent = lofiAudio.paused ? 'Play' : 'Pause';
    }

    function formatTime(seconds) {
      if (!Number.isFinite(seconds) || seconds < 0) return '0:00';
      const total = Math.floor(seconds);
      const m = Math.floor(total / 60);
      const s = total % 60;
      return `${m}:${String(s).padStart(2, '0')}`;
    }

    function updateLofiProgress() {
      const current = lofiAudio.currentTime || 0;
      const duration = lofiAudio.duration || 0;
      const ratio = duration > 0 ? (current / duration) * 100 : 0;
      document.getElementById('playlistProgressFill').style.width = `${ratio}%`;
      document.getElementById('playlistTime').textContent =
        `${formatTime(current)} / ${formatTime(duration)}`;
    }

    function createShuffledOrder() {
      const order = Array.from({ length: lofiTracks.length }, (_, i) => i);
      for (let i = order.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [order[i], order[j]] = [order[j], order[i]];
      }
      return order;
    }

    function initShuffle(randomStart = true) {
      shuffledOrder = createShuffledOrder();
      shufflePos = randomStart ? Math.floor(Math.random() * shuffledOrder.length) : 0;
      currentLofiTrack = shuffledOrder[shufflePos];
    }

    function reshuffleForNext() {
      const previousTrack = currentLofiTrack;
      shuffledOrder = createShuffledOrder();
      if (shuffledOrder.length > 1 && shuffledOrder[0] === previousTrack) {
        const swapIdx = 1 + Math.floor(Math.random() * (shuffledOrder.length - 1));
        [shuffledOrder[0], shuffledOrder[swapIdx]] = [shuffledOrder[swapIdx], shuffledOrder[0]];
      }
      shufflePos = 0;
      currentLofiTrack = shuffledOrder[shufflePos];
    }

    function loadLofiTrack(position, autoplay = false) {
      if (!shuffledOrder.length) initShuffle(true);
      const length = shuffledOrder.length;
      shufflePos = ((position % length) + length) % length;
      currentLofiTrack = shuffledOrder[shufflePos];
      lofiAudio.src = lofiTracks[currentLofiTrack].src;
      lofiAudio.load();
      updateTrackDisplay();
      updateLofiProgress();
      if (autoplay) {
        lofiAudio.play().then(updateLofiPlayButton).catch(() => updateLofiPlayButton());
      } else {
        updateLofiPlayButton();
      }
    }

    function toggleLofiPlayPause() {
      if (lofiAudio.paused) {
        lofiAudio.play().then(updateLofiPlayButton).catch(() => updateLofiPlayButton());
      } else {
        lofiAudio.pause();
        updateLofiPlayButton();
      }
    }

    function prevLofiTrack() {
      const shouldPlay = !lofiAudio.paused || (timerInterval && soundMode === 'lofi');
      if (!shuffledOrder.length) initShuffle(true);
      loadLofiTrack(shufflePos - 1, shouldPlay);
    }

    function nextLofiTrack() {
      const shouldPlay = !lofiAudio.paused || (timerInterval && soundMode === 'lofi');
      if (!shuffledOrder.length) initShuffle(true);
      if (shufflePos >= shuffledOrder.length - 1) {
        reshuffleForNext();
        loadLofiTrack(shufflePos, shouldPlay);
      } else {
        loadLofiTrack(shufflePos + 1, shouldPlay);
      }
    }

    function seekLofi(event) {
      if (!lofiAudio.duration) return;
      const bar = document.getElementById('playlistProgress');
      const rect = bar.getBoundingClientRect();
      const ratio = Math.min(1, Math.max(0, (event.clientX - rect.left) / rect.width));
      lofiAudio.currentTime = ratio * lofiAudio.duration;
      updateLofiProgress();
    }

    function updateClock() {
      if (timerInterval) return;
      document.getElementById('clock').textContent =
        new Date().toLocaleTimeString();
    }

    // --- Rain Sound ---
    let dropInterval = null;

    function startRain() {
      rainCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Brown noise via filtered white noise (rain-like)
      const bufferSize = 2 * rainCtx.sampleRate;
      const buffer = rainCtx.createBuffer(2, bufferSize, rainCtx.sampleRate);
      for (let ch = 0; ch < 2; ch++) {
        const data = buffer.getChannelData(ch);
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          lastOut = (lastOut + (0.02 * white)) / 1.02;
          data[i] = lastOut * 1.5;
        }
      }
      const noiseSource = rainCtx.createBufferSource();
      noiseSource.buffer = buffer;
      noiseSource.loop = true;

      // Bandpass filter ‚Äî lower frequency for softer rain
      const bandpass = rainCtx.createBiquadFilter();
      bandpass.type = 'bandpass';
      bandpass.frequency.value = 600;
      bandpass.Q.value = 0.5;

      // Highpass to remove rumble
      const highpass = rainCtx.createBiquadFilter();
      highpass.type = 'highpass';
      highpass.frequency.value = 200;

      // LFO for amplitude modulation (rain wave effect)
      const lfo = rainCtx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.15; // slow wave ~7 seconds
      const lfoGain = rainCtx.createGain();
      lfoGain.gain.value = 0.04; // modulation depth
      lfo.connect(lfoGain);

      const gain = rainCtx.createGain();
      gain.gain.value = 0;
      gain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.15, rainCtx.currentTime + 2);
      lfoGain.connect(gain.gain); // modulate the main gain

      noiseSource.connect(bandpass);
      bandpass.connect(highpass);
      highpass.connect(gain);
      gain.connect(rainCtx.destination);
      noiseSource.start();
      lfo.start();

      rainNodes = [noiseSource, bandpass, highpass, gain, lfo, lfoGain];

      // Second layer: higher pitched "patter"
      const patterBuffer = rainCtx.createBuffer(2, bufferSize, rainCtx.sampleRate);
      for (let ch = 0; ch < 2; ch++) {
        const data = patterBuffer.getChannelData(ch);
        for (let i = 0; i < bufferSize; i++) {
          data[i] = (Math.random() * 2 - 1) * (Math.random() < 0.3 ? 1 : 0.1);
        }
      }
      const patterSource = rainCtx.createBufferSource();
      patterSource.buffer = patterBuffer;
      patterSource.loop = true;

      const patterFilter = rainCtx.createBiquadFilter();
      patterFilter.type = 'bandpass';
      patterFilter.frequency.value = 4000;
      patterFilter.Q.value = 1.0;

      const patterGain = rainCtx.createGain();
      patterGain.gain.value = 0;
      patterGain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.04, rainCtx.currentTime + 2);

      patterSource.connect(patterFilter);
      patterFilter.connect(patterGain);
      patterGain.connect(rainCtx.destination);
      patterSource.start();

      rainNodes.push(patterSource, patterFilter, patterGain);

      // Third layer: sporadic raindrop sounds
      dropInterval = setInterval(() => {
        if (!rainCtx) return;
        const count = Math.floor(Math.random() * 3) + 1;
        for (let d = 0; d < count; d++) {
          setTimeout(() => playDrop(), Math.random() * 400);
        }
      }, 600 + Math.random() * 800);
    }

    function playDrop() {
      if (!rainCtx || isMuted) return;
      const osc = rainCtx.createOscillator();
      const g = rainCtx.createGain();
      const freq = 2000 + Math.random() * 4000;
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, rainCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(freq * 0.4, rainCtx.currentTime + 0.06);
      g.gain.setValueAtTime(0.02 + Math.random() * 0.02, rainCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, rainCtx.currentTime + 0.06);
      osc.connect(g);
      g.connect(rainCtx.destination);
      osc.start();
      osc.stop(rainCtx.currentTime + 0.07);
    }

    function stopRain() {
      if (!rainCtx) return;
      if (dropInterval) { clearInterval(dropInterval); dropInterval = null; }
      // Fade out main gain (index 3) and patter gain (index 8)
      const gain = rainNodes[3];
      const patterGain = rainNodes[8];
      const now = rainCtx.currentTime;
      gain.gain.cancelScheduledValues(now);
      gain.gain.linearRampToValueAtTime(0, now + 1.5);
      patterGain.gain.cancelScheduledValues(now);
      patterGain.gain.linearRampToValueAtTime(0, now + 1.5);
      setTimeout(() => {
        rainNodes.forEach(n => { try { n.stop(); } catch(e) {} });
        rainCtx.close();
        rainCtx = null;
        rainNodes = [];
      }, 2000);
    }

    function startLofi() {
      lofiAudio.muted = isMuted;
      lofiAudio.play().then(updateLofiPlayButton).catch(() => {
        soundMode = 'rain';
        updateSoundButton();
        updatePlaylistVisibility();
        updateLofiPlayButton();
        startRain();
      });
    }

    function stopLofi() {
      lofiAudio.pause();
      lofiAudio.currentTime = 0;
      updateLofiPlayButton();
      updateLofiProgress();
    }

    function startAmbience() {
      if (soundMode === 'lofi') {
        startLofi();
      } else {
        startRain();
      }
    }

    function stopAmbience() {
      stopRain();
      stopLofi();
    }

    // --- Timer ---
    function startTimer(minutes) {
      if (!minutes || minutes < 1) return;
      timerEndTime = Date.now() + minutes * 60 * 1000;
      const clockEl = document.getElementById('clock');
      clockEl.classList.add('countdown');
      document.getElementById('timerControls').classList.add('hidden');
      document.getElementById('cancelBtn').classList.remove('hidden');
      document.getElementById('soundModeBtn').classList.remove('hidden');
      document.getElementById('muteBtn').classList.remove('hidden');
      updatePlaylistVisibility();

      notifyFocus('start');
      startAmbience();

      timerInterval = setInterval(tickTimer, 200);
      tickTimer();
    }

    function tickTimer() {
      const remaining = timerEndTime - Date.now();
      if (remaining <= 0) {
        endTimer();
        return;
      }
      const totalSec = Math.ceil(remaining / 1000);
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      document.getElementById('clock').textContent =
        String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function endTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      timerEndTime = null;
      document.getElementById('clock').classList.remove('countdown');
      document.getElementById('timerControls').classList.remove('hidden');
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('soundModeBtn').classList.add('hidden');
      document.getElementById('muteBtn').classList.add('hidden');
      document.getElementById('playlistPanel').classList.add('hidden');
      updateClock();

      notifyFocus('stop');
      stopAmbience();
      playAlarm();
      showNotification();
    }

    function cancelTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      timerEndTime = null;
      document.getElementById('clock').classList.remove('countdown');
      document.getElementById('timerControls').classList.remove('hidden');
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('soundModeBtn').classList.add('hidden');
      document.getElementById('muteBtn').classList.add('hidden');
      document.getElementById('playlistPanel').classList.add('hidden');
      updateClock();

      notifyFocus('stop');
      stopAmbience();
    }

    function sendToSwift(action) {
      try {
        const handler = window?.webkit?.messageHandlers?.focus;
        if (!handler) return false;
        try {
          handler.postMessage({ action: action });
        } catch (_) {
          handler.postMessage(action);
        }
        return true;
      } catch (e) {}
      return false;
    }

    function notifyFocus(action) {
      sendToSwift(action);
      setTimeout(() => sendToSwift(action), 180);
    }

    function playAlarm() {
      if (isMuted) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const freqs = [880, 0, 880, 0, 880, 0, 1100, 0, 880];
      const step = 0.15;
      freqs.forEach((freq, i) => {
        if (freq === 0) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, ctx.currentTime + i * step);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * step + step * 0.9);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(ctx.currentTime + i * step);
        osc.stop(ctx.currentTime + i * step + step);
      });
    }

    function showNotification() {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        new Notification('Focus Timer', { body: 'Zeit ist um! Gute Arbeit.' });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(p => {
          if (p === 'granted')
            new Notification('Focus Timer', { body: 'Zeit ist um! Gute Arbeit.' });
        });
      }
    }

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    try {
      applyTheme(localStorage.getItem('clock_theme') || 'dark');
    } catch (_) {
      applyTheme('dark');
    }
    updateClock();
    initShuffle(true);
    loadLofiTrack(shufflePos, false);
    updateMuteButton();
    lofiAudio.addEventListener('timeupdate', updateLofiProgress);
    lofiAudio.addEventListener('loadedmetadata', updateLofiProgress);
    lofiAudio.addEventListener('ended', () => nextLofiTrack());
    lofiAudio.addEventListener('play', updateLofiPlayButton);
    lofiAudio.addEventListener('pause', updateLofiPlayButton);
    window.handleNativeUpdateState = handleNativeUpdateState;
    updateSoundButton();
    setInterval(updateClock, 1000);
    showQuote();
    setInterval(showQuote, 5 * 60 * 1000);
  </script>
</body>
</html>
